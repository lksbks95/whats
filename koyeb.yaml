# Ficheiro de configuração para deploy no Koyeb
# Coloque este ficheiro na raiz do seu repositório (ex: /whats/koyeb.yaml)

# Nome do serviço no Koyeb
name: whatsapp-service

# Define as variáveis de ambiente necessárias
env:
  - key: SECRET_KEY
    # Crie uma chave segura e coloque aqui ou configure no painel do Koyeb
    value: "uma-chave-super-secreta-e-longa-aqui"
  - key: DATABASE_URL
    # Use a variável do PostgreSQL fornecida pelo Koyeb
    scope: "system"
    
# Define os serviços a serem executados
services:
  - name: web
    # Define o tipo de instância (o plano 'free' é gratuito)
    instance_type: free
    
    # Configuração do Git para encontrar o código
    git:
      branch: main
      repository: "lksbks95/whats"
      
    # Comandos de Build: A receita para construir a sua aplicação
    build_command: |
      echo "--- A instalar dependências do Backend ---"
      pip install -r backend/requirements.txt
      
      echo "--- A instalar dependências do Frontend ---"
      cd frontend
      pnpm install
      
      echo "--- A compilar o Frontend ---"
      pnpm run build
      
      echo "--- Build Concluído ---"
      
    # Comando de Run: Como iniciar o seu servidor em produção
    # Inicia o Gunicorn a partir da pasta do backend
    run_command: "gunicorn --chdir backend main:app --worker-class geventwebsocket.gunicorn.workers.GeventWebSocketWorker -w 1"
    
    # Configuração de Health Checks para o Koyeb saber se a app está saudável
    health_checks:
      - path: "/"
        port: 8000
        protocol: http
        
# Define as portas que a sua aplicação irá expor
ports:
  - port: 8000
    protocol: http
    
# Define as rotas públicas
routes:
  - path: "/"
    service: web
